<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0 minimum-scale=1.0">
		<title>Sample Socket.io Chat</title>
		<style>
			body {
				margin: 0;
				padding-bottom: 3rem;
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
			}
			body.dark-mode {
				background-color: #171719;
				color: white;
			}
			header {
    			display: flex;
			    border-bottom: 1px solid #e1e1e1;
			}
			.dark-mode header {
				border-bottom: 1px solid #2f2f35;
			}
			header h1 {
				padding: 10px;
				margin: 0 auto;
				font-size: 16px;
				font-weight: 400;
			}
			button#chat-setting {
    			background: white;
    			border: none;
				margin-right: 10px;
			}
			.dark-mode button#chat-setting {
				background: #171719;
			}
			button#chat-setting img {
    			width: auto;
    			height: 17px;
    			padding: 10px;
			}
			.dark-mode button#chat-setting img {
				filter: invert(100%) sepia(0%) saturate(7480%) hue-rotate(318deg) brightness(107%) contrast(105%);
			}
			button#chat-setting img:hover {
    			background: #e5e5e5;
				border-radius: 6px;
			}
			#theme-toggle-container {
				position: absolute;
				top: 40px;
				right: 4px;
				background: rgba(255, 255, 255, 0.9);
				padding: 10px;
				border-radius: 5px;
				box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
				z-index: 100;
				width: 200px;
    			height: 66px;
			}
			.dark-mode #theme-toggle-container {
				background: #1d1d20;
				color: white;
				box-shadow: 0px 2px 5px rgb(0, 0, 0);
			}
			.flex-box {
    			display: flex;
    			margin-bottom: 10px;
			}
			label.set-text {
				flex: 1;  /* ãƒ†ã‚­ã‚¹ãƒˆã®å¹…ã‚’è‡ªå‹•ã§èª¿æ•´ */
    			padding-left: 5px;
			}
			/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ•ã®ã¨ãã« <time> ã‚¿ã‚°ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
			#time-toggle:checked + time {
    			display: none;
			}
			/* start switch */
			/* ã‚¹ã‚¤ãƒƒãƒå…¨ä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
			.switch {
				position: relative;
				display: inline-block;
				width: 50px;  /* æ¨ªé•·ã‚µã‚¤ã‚º */
				height: 24px;
			}
			/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’éè¡¨ç¤ºï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ç”¨ï¼‰ */
			.switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}
			/* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆã‚¹ã‚¤ãƒƒãƒã®èƒŒæ™¯éƒ¨åˆ†ï¼‰ */
			.slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #ccc;  /* ã‚ªãƒ•æ™‚ã®è‰² */
				transition: 0.4s;
				border-radius: 34px;  /* è§’ã‚’ä¸¸ã */
			}
			/* ä¸¸ã„éƒ¨åˆ†ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹éƒ¨åˆ†ï¼‰ */
			.slider::before {
				position: absolute;
				content: "";
				height: 18px;
				width: 18px;
				left: 3px;
				bottom: 3px;
				background-color: white;
				transition: 0.4s;
				border-radius: 50%;
			}
			/* ONã®ã¨ãã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆèƒŒæ™¯è‰²ã‚’å¤‰æ›´ï¼†ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç§»å‹•ï¼‰ */
			input:checked + .slider {
				background-color: #4CAF50;  /* ONæ™‚ã®èƒŒæ™¯è‰² */
			}
			input:checked + .slider::before {
				transform: translateX(26px);  /* ä¸¸ã‚’å³ã¸ç§»å‹• */
			}
			/* end switch */
			#chatForm {
				display: flex;
				border-top: 1px solid #e5e5e5;
				padding-top: 10px;
				padding-bottom: 6px;
				position: fixed;
				bottom: 0px;
				left: 0;
				right: 0;
			}
			.dark-mode #chatForm {
				border-top: 1px solid #414141;
			}
			#chat-name {
				height: 39px;
				padding-left: 11px;
				box-sizing: border-box;
				border: none;
				/*border-radius: 2rem;*/
				background: #efefef;
				margin: 0px -11px 0px 14px;
				display: none;
			}
			.wrapper {
				position: relative;
				width: 100%;
			}
			#chatPreview {
    			width: 100%;
				height: 39px; /* é«˜ã•ã‚’èª¿æ•´  å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ */
				font-size: 16px;
				box-sizing: border-box;
				resize: none; /* æ‰‹å‹•ãƒªã‚µã‚¤ã‚ºç¦æ­¢ */
				line-height: 18px; /* æ–‡å­—ã®é«˜ã•å¹…ã‚’èª¿æ•´  ä¸Šä¸‹é–“éš”ã«ãªã‚‹ã®ã«æ³¨æ„ */
				padding-top: 11px;
				padding-left: 18px;
				padding-right: 18px;
				overflow-y: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º */
				border: none;
				background: #f2f2f2;
				font-family: sans-serif;
				border-radius: 2rem;
				margin-left: 23px;
				outline: none;
			}
			.dark-mode #chatPreview {
				background: #292929;
				/*outline: 1px solid #656568;*/
			}
			img.chat-emote {
    			vertical-align: middle;
    			margin: -6px 2px 0px 4px;
			}
			#input {
				width: 100%;
				height: 39px; /* é«˜ã•ã‚’èª¿æ•´  å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ */
				font-size: 14px;
				box-sizing: border-box;
				resize: none; /* æ‰‹å‹•ãƒªã‚µã‚¤ã‚ºç¦æ­¢ */
				line-height: 18px; /* æ–‡å­—ã®é«˜ã•å¹…ã‚’èª¿æ•´  ä¸Šä¸‹é–“éš”ã«ãªã‚‹ã®ã«æ³¨æ„ */
				padding-top: 11px;
				padding-left: 18px;
				padding-right: 18px;
				overflow-y: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º */
				border: none;
				background: #f2f2f2;
				font-family: sans-serif;
				border-radius: 2rem;
				margin-left: 23px;
				display: none; /* å®Œå…¨ã«éš ã™ */
			}
			#input:focus {
				outline: none;
			}
			.emoji-picker {
				display: none;
				position: absolute;
				background: white;
				border: 1px solid #ddd;
				border-radius: 8px;
				padding: 10px;
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
				max-width: 372px;
				max-height: 400px;
				flex-wrap: wrap;
				gap: 10px;
				right: -80px;
				bottom: 54px;
				overflow-y: auto;
			}
			.dark-mode .emoji-picker {
				background: #1d1d20;
				border: 1px solid #1d1d20;
				box-shadow: 0 4px 6px rgb(0 0 0 / 65%);
			}
			.emoji-picker img {
				width: 28px;
    			height: 28px;
    			cursor: pointer;
    			transition: transform 0.2s;
			}
			.emoji-picker img:hover {
    			transform: scale(1.2);
			}
			.emoji {
				font-size: 28px;
				cursor: pointer;
				/*padding: 5px;*/
				border-radius: 5px;
				transition: background 0.2s;
			}
			.emoji:hover {
				background: #f0f0f0;
			}
			.separator {
    			width: 100%;
    			text-align: left;
    			font-size: 14px;
				font-weight: bold;
				margin: 8px 0;
				padding: 4px 0px;
				/*border-top: 2px solid #ddd;*/ /* ä¸Šã«åŒºåˆ‡ã‚Šç·š */
  				color: #666;
			}
			.dark-mode .separator {
				background: #171719;
				color: white;
			}
			button.emoji-button {
				position: absolute;
				right: -14px;
				top: 9px;
				border: none;
				background: none;
				/*display: none;*/
			}
			/* start ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆtooltipï¼‰ */
			button.emoji-button::after {
				content: attr(data-title);
				position: absolute;
				top: -50px; /* ãƒœã‚¿ãƒ³ã®ä¸Šã«è¡¨ç¤º */
				left: 50%;
				transform: translateX(-50%);
				background: #707070;
				color: #e9e9e9;
				padding: 10px 10px;
				border-radius: 5px;
				font-size: 12px;
				white-space: nowrap;
				opacity: 0;
				visibility: hidden;
				transition: opacity 0.2s ease-in-out;
				pointer-events: none;
			}
			/* å¹ãå‡ºã—ã®ä¸‹ã‚„ã˜ã‚‹ã—ä¸‰è§’å½¢ã‚’ä½œã‚‹ */
			button.emoji-button::before {
				content: "";
				position: absolute;
				top: -12px; /* å¹ãå‡ºã—ã®ä¸‰è§’å½¢ã®ä½ç½® */
				left: 50%;
				transform: translateX(-50%);
				border-width: 5px;
				border-style: solid;
				border-color: #707070 transparent transparent transparent;
				opacity: 0;
				visibility: hidden;
				transition: opacity 0.2s ease-in-out;
			}
			.emoji-button:hover::after,
			.emoji-button:hover::before {
				opacity: 1;
				visibility: visible;
			}
			/* end ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼ˆtooltipï¼‰ */
			button.emoji-button > img {
				width: auto;
				height: 20px;
				filter: invert(51%) sepia(3%) saturate(10%) hue-rotate(15deg) brightness(101%) contrast(92%);
			}
			.dark-mode button.emoji-button > img {
				/* #ffffff */
				filter: invert(100%) sepia(0%) saturate(7480%) hue-rotate(318deg) brightness(107%) contrast(105%);
				/* #e3e3e3 */
				filter: invert(99%) sepia(67%) saturate(429%) hue-rotate(195deg) brightness(116%) contrast(78%);
			}
            button.send {
				border: none;
				background: #ffffff;
				margin: 0px 18px 0px 30px;
            }
			.dark-mode button.send {
				background: #171719;
			}
			button.send > img {
				/*transform: rotateZ(28deg);*/
				width: auto;
				height: 22px;
				filter: invert(1%) sepia(5%) saturate(145%) hue-rotate(314deg) brightness(93%) contrast(91%);
				filter: invert(13%) sepia(9%) saturate(19%) hue-rotate(337deg) brightness(93%) contrast(80%);
				filter: invert(22%) sepia(16%) saturate(4%) hue-rotate(315deg) brightness(102%) contrast(81%);
			}
			.dark-mode button.send > img {
				/* #ffffff */
				filter: invert(100%) sepia(0%) saturate(7480%) hue-rotate(318deg) brightness(107%) contrast(105%);
				/* #f3f3f3 */
				filter: invert(99%) sepia(77%) saturate(20%) hue-rotate(278deg) brightness(110%) contrast(91%);
				/* #e3e3e3 */
				filter: invert(99%) sepia(67%) saturate(429%) hue-rotate(195deg) brightness(116%) contrast(78%);
			}
			#messages {
				list-style-type: none;
				margin: 0 0 23px 0;
				padding: 0; 
				position: fixed;
				width: 100%;
				top: 52px;
				bottom: 46px;
				overflow: auto;
			}
			#messages > li:nth-child(odd) {
				background: #f8f8f8;
			}
			.dark-mode #messages > li:nth-child(odd) {
				background: #171719;
			}
			#messages > li {
				display: flex;
				position: relative;
				padding: 0.5rem 1rem;
				animation: fadeIn 0.3s ease 0s 1 normal;
			}
			/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
			@keyframes fadeIn {
				0% {
					opacity: 0;
					transform: translateY(10px);
				}
				100% {
					opacity: 1;
				}
			}
			li > span > img {
				width: auto;
				height: 26px;
				border-radius: 100%;
				/*margin: -20px 7px -8px 7px;*/
			}
			#messages > li time {
				font-size: 0.7rem;
				color: #a8a8a8;
				padding-right: 6px;
				display: inline;
				/* display: none; */
			}
			.msg-icon {
				height: 21px;
				padding: 0 12px 0px 6px;
				margin-top: -2px;
				/* display: none; */
			}
			.msg-name {
				font-size: 12px;
				font-weight: bold;
				color: #797979;
				color: #146512;
				color: #027523;
				padding-right: 2px;
			}
			.msg-text {
				font-size: 13px;
			}
			.msg-text img {
    			/* height: 26px; */
    			margin-bottom: -6px;
    			margin-top: -10px;
				/*padding-right: 6px;*/
			}
			@media screen and (max-width: 430px) {
				#input {
					font-size: 16px;
				}
				/*button.emoji-button {
					display: none;
				}*/
				li > span > img {
					height: 26px;
				}
				#messages > li time {
                    padding-right: 3px;
					/*display: none;*/
				}
				.msg-icon {
					height: 21px;
					padding: 0px 10px 0px 0px;
					margin-top: -2px;
				}
				.msg-name {
					font-size: 12px;
					padding-right: 2px;
				}
				.msg-text {
					font-size: 13px;
				}
			}
		</style>
		<style id="emoji-tooltip">
			.emoji-button:hover::after,
			.emoji-button:hover::before {
				opacity: 1;
				visibility: visible;
			}
		</style>
	</head>
	<body>
		<header>
			<h1>ãƒãƒ£ãƒƒãƒˆ</h1>
			<button type="button" id="chat-setting">
				<img src="icon/ellipsis-vertical-solid.svg" alt="setting">
			</button>
		</header>
		<!-- start è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
		<div id="theme-toggle-container" style="display: none;">
			<div class="flex-box">
				<label for="theme-toggle" class="set-text">â˜¾ ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ</label>
				<label class="switch">
					<input type="checkbox" id="theme-toggle">
					<span class="slider"></span>
				</label>
			</div>
			<div class="flex-box">
				<label for="time-toggle" class="set-text">â†» ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</label>
				<label class="switch">
					<input type="checkbox" id="time-toggle" checked>
					<span class="slider"></span>
				</label>
			</div>
		</div>
		<!-- end è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
		<ul id="messages"></ul>
		<form id="chatForm" action="/submit" method="POST">
			<input id="chat-name" name="_name" value="sampleã‚µãƒ³ãƒ—ãƒ«:">
			<div id="wrapper" class="wrapper">
				<div id="chatPreview" contenteditable="true"></div>
				<textarea id="input" name="_message" placeholder="ãƒãƒ£ãƒƒãƒˆ..." autocomplete="off"></textarea>
                <input type="hidden" name="_csrf" id="csrf-token">
				<button type="button" id="emoji-button" class="emoji-button" data-title="ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ ">
					<img src="icon/face-smile-regular.svg" alt="ğŸ˜€">
				</button>
				<div id="emoji-picker" class="emoji-picker"></div>
			</div>
			<button type="submit" class="send">
				<img src="icon/paper-plane-regular.svg" class="send-img" alt="Send">
			</button>
		</form>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			let socket = io();
			let twitchUserInfo = null; // twitchã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ç”¨æ„ã™ã‚‹
			const messages = document.getElementById('messages');
			const input = document.getElementById("input");
			const form = document.getElementById("chatForm");
			const chatName = document.getElementById('chat-name');
			const emojiButton = document.getElementById("emoji-button");
			const emojiPicker = document.getElementById("emoji-picker");
			const tooltipStyle = document.getElementById("emoji-tooltip");
			const sendImg = document.querySelector(".send-img");
			let isComposing = false; // IMEå¤‰æ›ä¸­ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ•ãƒ©ã‚°
			let canSubmit = true; // é€ä¿¡å¯èƒ½ã‹ã©ã†ã‹ã‚’ç®¡ç†ã™ã‚‹ãƒ•ãƒ©ã‚°

			const chatPreview = document.getElementById("chatPreview");

			// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã‚’åŒæœŸã™ã‚‹
			chatPreview.addEventListener("input", () => {
    			input.value = chatPreview.innerHTML; // HTMLã‚’ãã®ã¾ã¾ `textarea` ã«å…¥ã‚Œã‚‹
			});

			// ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’å–å¾—
			const darkModeToggle = document.getElementById("theme-toggle");
			const timeToggle = document.getElementById("time-toggle");

			// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
			document.addEventListener("DOMContentLoaded", () => {
				// ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã®å¾©å…ƒ
				const savedDarkMode = localStorage.getItem("darkModeState");
    			if (savedDarkMode !== null) {
        			if (savedDarkMode === "true") {
            			document.body.classList.add("dark-mode");
            			darkModeToggle.checked = true;
        			} else {
            			document.body.classList.remove("dark-mode");
            			darkModeToggle.checked = false;
        			}
    			}
				// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®è¡¨ç¤º/éè¡¨ç¤ºã®å¾©å…ƒ
				const savedTimeToggle = localStorage.getItem("timeToggleState");
    			if (savedTimeToggle !== null) {
        			timeToggle.checked = savedTimeToggle === "true";
    			}
			});

			// ãƒãƒ£ãƒƒãƒˆè¨­å®šã®è¡¨ç¤º
			const settingButton = document.getElementById("chat-setting");
			const menu = document.getElementById("theme-toggle-container");
			settingButton.addEventListener("click", () => {
				menu.style.display = menu.style.display === "none" ? "block" : "none";
				//console.log("âœ… è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã:", menu); // ãƒ‡ãƒãƒƒã‚°ç”¨
			});

			// ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ£ãƒƒãƒˆè¨­å®šã‚’é–‰ã˜ã‚‹
			document.addEventListener("click", (event) => {
  				// ãƒãƒ£ãƒƒãƒˆè¨­å®šãƒœã‚¿ãƒ³ã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
  				if (!settingButton.contains(event.target) && !menu.contains(event.target)) {
    				menu.style.display = "none"; // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
  				}
			});

			// ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã®è¨­å®š
			darkModeToggle.addEventListener("change", (event) => {
				localStorage.setItem("darkModeState", darkModeToggle.checked);
				//console.log("âœ… ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸï¼", event.target.checked); // ãƒ‡ãƒãƒƒã‚°ç”¨
				document.body.classList.toggle("dark-mode", event.target.checked);
				if (document.body.classList.contains("dark-mode")) {
					sendImg.style.filter = "invert(99%) sepia(67%) saturate(429%) hue-rotate(195deg) brightness(116%) contrast(78%)";
				} else {
					sendImg.style.filter = "invert(22%) sepia(16%) saturate(4%) hue-rotate(315deg) brightness(102%) contrast(81%)";
				}
			});

			// ã‚¹ã‚¤ãƒƒãƒã®å¤‰æ›´æ™‚ã« ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—<time> ã®è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆæœ€æ–°ã® <time> ã‚’å–å¾—ï¼‰
			timeToggle.addEventListener("change", (event) => {
				localStorage.setItem("timeToggleState", timeToggle.checked);
				//console.log("âœ… ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸï¼", event.target.checked); // ãƒ‡ãƒãƒƒã‚°ç”¨
				updateTimeVisibility(); // <time> ã®è¡¨ç¤ºã‚’æ›´æ–°
			});

			// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—<time> ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
			function updateTimeVisibility() {
    			const timeElements = document.querySelectorAll("time"); // æœ€æ–°ã® <time> ã‚’å–å¾—
    			//console.log("ğŸ“Œ ç¾åœ¨ã® <time> è¦ç´ æ•°:", timeElements.length); // ãƒ‡ãƒãƒƒã‚°ç”¨

				timeElements.forEach(time => {
					time.style.display = timeToggle.checked ? "inline" : "none";
					//console.log(`ğŸ•’ ${time.textContent} â†’ ${time.style.display}`); // ãƒ‡ãƒãƒƒã‚°ç”¨
				});
			}

			// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«ã‚‚ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—<time> ã®è¡¨ç¤ºã‚’é©ç”¨
			function onMessageSent() {
    			updateTimeVisibility(); // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸ <time> ã‚‚å¯¾è±¡ã«ã™ã‚‹
			}

			window.onload = async function () {
    			try {
        			await Promise.all([
            			updateCsrfToken(),   // CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
            			fetchTwitchUserInfo(), // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
					]);
					console.log("âœ… ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼");
				} catch (error) {
					console.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
    			}
			};

			// âœ… 1. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
			async function fetchTwitchUserInfo() {
				try {
					const response = await fetch("/twitch/user", {
						method: "GET",
						credentials: "include"
					});

					const data = await response.json();

					twitchUserInfo = data;  // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        			//console.log("ğŸ­ Twitchãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:", twitchUserInfo); // (ãƒ‡ãƒãƒƒã‚°ç”¨)

					chatName.value = twitchUserInfo.display_name;

					// æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ or æœ‰åŠ¹æœŸé™åˆ‡ã‚Œãªã‚‰ Twitch èªè¨¼ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼
					if (data.login_url) {
						console.warn("âš ï¸ æœªãƒ­ã‚°ã‚¤ãƒ³ or ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ! Twitch OAuth ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼");
						window.location.href = data.login_url;
						return;
					}

				} catch (error) {
					console.error("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—:", error);
				}
			}

			// CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
			async function updateCsrfToken() {
				const res = await fetch('/csrf-token');
				const data = await res.json();
				document.getElementById('csrf-token').value = data.csrfToken;
				console.log("âœ… New CSRF Token retrieved:", data.csrfToken); // (ãƒ‡ãƒãƒƒã‚°ç”¨)
			}
			
			// IMEå¤‰æ›é–‹å§‹æ™‚ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
			chatPreview.addEventListener("compositionstart", () => {
				isComposing = true;
				canSubmit = false; // å¤‰æ›ä¸­ã¯é€ä¿¡ã§ããªã„
			});
			
			// IMEå¤‰æ›ç¢ºå®šæ™‚ã«ãƒ•ãƒ©ã‚°ã‚’è§£é™¤ï¼ˆç¢ºå®šå¾Œã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ or ã‚­ãƒ¼ã‚¢ãƒƒãƒ—ã‚’å¾…ã¤ï¼‰
			chatPreview.addEventListener("compositionend", () => {
				isComposing = false;
				// Safariå¯¾ç­–: `input` or `keyup` ãŒæ¥ã‚‹ã¾ã§ `canSubmit` ã‚’ `false` ã®ã¾ã¾ã«ã™ã‚‹
			});

			// Twitch ã®ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆè‡ªåˆ†ç”¨ï¼‰
			async function fetchTwitchEmotes() {
    			try {
        			const response = await fetch("/twitch/emotes/my", { credentials: "include" });
        			const data = await response.json();

        			//console.log("ğŸ“¢ `Twitchã‚¨ãƒ¢ãƒ¼ãƒˆï¼ˆè‡ªåˆ†ï¼‰` ã®ä¸­èº«:", data); // ãƒ‡ãƒãƒƒã‚°ç”¨

        			// Twitch API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚¨ãƒ¢ãƒ¼ãƒˆé…åˆ—ã‚’å–å¾—
        			return data.data || []; // `data.data` ã‚’è¿”ã™ï¼ˆãªã‹ã£ãŸã‚‰ç©ºé…åˆ—ï¼‰

    			} catch (error) {
        			console.error("âŒ Twitchã‚¨ãƒ¢ãƒ¼ãƒˆå–å¾—å¤±æ•—:", error);
        			return []; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã™
    			}
			}

			// Twitch ã®ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼‰
			async function fetchTwitchEmotesYour() {
    			try {
        			const response = await fetch("/twitch/emotes/your", { credentials: "include" });
        			const data = await response.json();

        			//console.log("ğŸ“¢ `Twitchã‚¨ãƒ¢ãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰` ã®ä¸­èº«:", data); // ãƒ‡ãƒãƒƒã‚°ç”¨

        			// Twitch API ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ã‚¨ãƒ¢ãƒ¼ãƒˆé…åˆ—ã‚’å–å¾—
        			return data.data || []; // `data.data` ã‚’è¿”ã™ï¼ˆãªã‹ã£ãŸã‚‰ç©ºé…åˆ—ï¼‰

    			} catch (error) {
        			console.error("âŒ Twitchã‚¨ãƒ¢ãƒ¼ãƒˆå–å¾—å¤±æ•—:", error);
        			return []; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã‚’è¿”ã™
    			}
			}

			// Twitch ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’å–å¾—
			async function fetchGlobalEmotes() {
				try {
					const response = await fetch("/twitch/emotes/global");
					const data = await response.json();
					//console.log("ğŸŒ `ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¢ãƒ¼ãƒˆ` ã®ä¸­èº«:", data); // ãƒ‡ãƒãƒƒã‚°ç”¨
					return data.data || [];
				} catch (error) {
					console.error("âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¢ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—:", error);
					return [];
				}
			}

			// è¡¨ç¤ºã™ã‚‹çµµæ–‡å­—ä¸€è¦§
			const emojis = ["ğŸ˜Œ", "ğŸ˜­", "ğŸ˜€", "ğŸ˜", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜…", "ğŸ˜†", "â˜ºï¸", "ğŸ˜‡",
							"ğŸ˜", "ğŸ˜¡", "ğŸ˜“", "ğŸ˜´", "ğŸ˜¨", "ğŸ¤”", "ğŸ¥¹", "ğŸ˜”", "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‹", "ğŸ˜"
			];

			// ğŸ“Œ åŒºåˆ‡ã‚Šç·šã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
			function addSeparator(labelText) {
				const separator = document.createElement("div");
				separator.textContent = labelText; // ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
				separator.classList.add("separator"); // CSSã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã¤ã‘ã‚‹
				emojiPicker.appendChild(separator);
			}

			// çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’ç”Ÿæˆ **âœ… ã™ã¹ã¦ã®ã‚¨ãƒ¢ãƒ¼ãƒˆï¼†çµµæ–‡å­—ã‚’çµ±åˆã™ã‚‹é–¢æ•°**
			async function createEmojiPicker() {
				emojiPicker.innerHTML = ""; // emojiPicker ã®ä¸­èº«ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ï¼ˆæ–°ã—ãä½œã‚Šç›´ã™ãŸã‚ï¼‰

				// **1ï¸âƒ£ æ™®é€šã®çµµæ–‡å­—ã®åŒºåˆ‡ã‚Šç·š**
				addSeparator("ğŸ˜€ çµµæ–‡å­—");

				// æ™®é€šã®çµµæ–‡å­—
				emojis.forEach(emoji => {
					const span = document.createElement("span"); // <span> è¦ç´ ã‚’ä½œã‚‹
					span.textContent = emoji; // çµµæ–‡å­—ã‚’ <span> ã®ä¸­ã«å…¥ã‚Œã‚‹
					span.classList.add("emoji"); // CSS ã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã« emoji ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
					span.addEventListener("click", () => insertEmoji(emoji)); // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ insertEmoji() ã‚’å®Ÿè¡Œ
					emojiPicker.appendChild(span); // emojiPickerï¼ˆçµµæ–‡å­—ä¸€è¦§ã® divï¼‰ã®ä¸­ã« span ã‚’è¿½åŠ ã™ã‚‹
				});

				// **2ï¸âƒ£ è‡ªåˆ†ã®ã‚¨ãƒ¢ãƒ¼ãƒˆã®åŒºåˆ‡ã‚Šç·š**
				addSeparator("ğŸ’¬ ä¸‰ã¤ç·¨ã¿ã‚¨ãƒ¢ãƒ¼ãƒˆ");

				// Twitchã‚¨ãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ ï¼ˆè‡ªåˆ†ã®ï¼‰
				const myEmotes = await fetchTwitchEmotes();
				myEmotes.forEach(emote => {
					const img = document.createElement("img");
            		img.src = emote.images.url_1x; // å°ã•ã„ã‚µã‚¤ã‚ºã®ã‚¨ãƒ¢ãƒ¼ãƒˆ
            		img.alt = emote.name;
            		img.title = emote.name; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®è¡¨ç¤ºå
            		img.classList.add("emote"); // CSSã§ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´
            		img.addEventListener("click", () => insertEmoji(img.src)); // ã‚¯ãƒªãƒƒã‚¯ã§æŒ¿å…¥
            		emojiPicker.appendChild(img);
				});

				//console.log("âœ… ã‚¨ãƒ¢ãƒ¼ãƒˆãƒ”ãƒƒã‚«ãƒ¼ã« è‡ªåˆ†ã® Twitch ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ ï¼"); // ãƒ‡ãƒãƒƒã‚°ç”¨

				//Twitchã‚¨ãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ï¼‰
				const yourEmotes = await fetchTwitchEmotesYour();
				if (yourEmotes.length > 0) {
					addSeparator(`ğŸ”– ${chatName.value}ã‚¨ãƒ¢ãƒ¼ãƒˆ`); // **3ï¸âƒ£ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¨ãƒ¢ãƒ¼ãƒˆã®åŒºåˆ‡ã‚Šç·š**
					yourEmotes.forEach(emote => {
						const img = document.createElement("img");
						img.src = emote.images.url_1x;
						img.alt = emote.name;
						img.title = emote.name;
						img.classList.add("emote");
						img.addEventListener("click", () => insertEmoji(img.src));
						emojiPicker.appendChild(img);
					})
					//console.log(`âœ… ã‚¨ãƒ¢ãƒ¼ãƒˆãƒ”ãƒƒã‚«ãƒ¼ã« ${chatName.value}ã® Twitch ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ ï¼`); // ãƒ‡ãƒãƒƒã‚°ç”¨
				} else {
					console.log("âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¢ãƒ¼ãƒˆãŒç©ºã§ã™ã€‚");
				}

				// **4ï¸âƒ£ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¢ãƒ¼ãƒˆã®åŒºåˆ‡ã‚Šç·š**
				addSeparator("ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¢ãƒ¼ãƒˆ");

				// Twitchã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ 
				const globalEmotes = await fetchGlobalEmotes();
				globalEmotes.forEach(emote => {
					const img = document.createElement("img");
					img.src = emote.images.url_1x;
					img.alt = emote.name;
					img.title = emote.name;
					img.classList.add("emote");
					img.addEventListener("click", () => insertEmoji(img.src));
					emojiPicker.appendChild(img);
				});

				//console.log("âœ… ã‚¨ãƒ¢ãƒ¼ãƒˆãƒ”ãƒƒã‚«ãƒ¼ã« ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ ï¼"); // ãƒ‡ãƒãƒƒã‚°ç”¨
			}
			
			// çµµæ–‡å­—ã‚’ textarea ã«æŒ¿å…¥
			function insertEmoji(emoji) {
				if (/^[\p{Emoji}\p{Extended_Pictographic}]+$/u.test(emoji)) {
					chatPreview.innerText += emoji;
				} else {
					chatPreview.innerHTML += `<img src="${emoji}" alt="emote" class="chat-emote">`;
				}
				input.value = chatPreview.innerHTML; // `textarea` ã«ã‚‚åæ˜ 

				// **ã‚«ãƒ¼ã‚½ãƒ«ã‚’ chatPreview ã®æœ«å°¾ã«æˆ»ã™**
				const range = document.createRange();
				const selection = window.getSelection();
				range.selectNodeContents(chatPreview);
				range.collapse(false); // æœ«å°¾ã«ç§»å‹•
				selection.removeAllRanges();
				selection.addRange(range);

				chatPreview.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
			}
			
			// ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰çµµæ–‡å­—ä¸€è¦§ã‚’è¡¨ç¤ºãƒ»éè¡¨ç¤º
			emojiButton.addEventListener("click", (event) => {
				createEmojiPicker(); // é–¢æ•°ã‚’å®Ÿè¡Œ çµµæ–‡å­—ãƒªã‚¹ãƒˆã‚’ä½œæˆ
				// if æ–‡ã‚’çŸ­ãã‹ã„ãŸ ä¸‰é …æ¼”ç®—å­ï¼ˆ?:ï¼‰ã‚’ä½¿ã£ãŸæ¡ä»¶åˆ†å²
				emojiPicker.style.display = emojiPicker.style.display === "flex" ? "none" : "flex";
				// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹
				tooltipStyle.textContent = `
					.emoji-button:hover::after,
					.emoji-button:hover::before {
						opacity: 0;
						visibility: hidden;
					}
				`;
			});
			
			// ã‚¯ãƒªãƒƒã‚¯ã§çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆãƒœã‚¿ãƒ³ã¨ãƒ”ãƒƒã‚«ãƒ¼ä»¥å¤–ï¼‰ï¼† tooltip ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æˆ»ã™
			document.addEventListener("click", (event) => {
				if (!emojiButton.contains(event.target) && !emojiPicker.contains(event.target)) {
					emojiPicker.style.display = "none";
					tooltipStyle.textContent = `
						.emoji-button:hover::after,
						.emoji-button:hover::before {
							opacity: 1;
							visibility: visible;
						}
					`;
				}
			});
			
			// ãƒ†ã‚­ã‚¹ãƒˆã®å¹…ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
			function getTextWidth(text, font) {
				const canvas = document.createElement("canvas"); // canvas è¦ç´ ã‚’ä½œæˆ
				const context = canvas.getContext("2d"); // 2Dã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆgetContext("2d")ã‚’å–å¾—
				context.font = font; // textarea ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’é©ç”¨
				return context.measureText(text).width; // ãƒªã‚¿ãƒ¼ãƒ³ã§ã€Œç¾åœ¨ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã§ text ã‚’æã„ãŸæ™‚ã®æ¨ªå¹…ã€ã‚’è¿”ã™
			}
			
			// ã‚¹ãƒãƒ›åˆ¤å®šé–¢æ•°
			function isMobile() {
				return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
			}
			
			/*if (isMobile()) {
				emojiButton.style.display = "none"; // ã‚¹ãƒãƒ›ãªã‚‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
			}*/
			
			// è‡ªå‹•ãƒªã‚µã‚¤ã‚ºé–¢æ•°
			function adjustTextareaHeight() {
				chatPreview.style.height = "39px"; // ä¸€åº¦ãƒªã‚»ãƒƒãƒˆã™ã‚‹
				
				const newLine = chatPreview.innerHTML.includes("<br>"); // æ”¹è¡Œã®ç¢ºèªã€‚
				const twoHeight = 47; // 2è¡Œåˆ†ã®é«˜ã•
				let newHeight = chatPreview.scrollHeight; // ç¾åœ¨ã®é«˜ã•
				
				//console.log("ç¾åœ¨ã®é«˜ã•:", newHeight); // ç¾åœ¨ã®é«˜ã•ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
				//console.log("ï¼’è¡Œåˆ†ã®é«˜ã•:", twoHeight); // ï¼’è¡Œåˆ†ã®é«˜ã•ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
				
				// textarea ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
				const chatPreviewStyle = window.getComputedStyle(chatPreview);
				const font = `${chatPreviewStyle.fontSize} ${chatPreviewStyle.fontFamily}`;
				
				// ç¾åœ¨ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®å¹…ã‚’è¨ˆç®—
				const textWidth = getTextWidth(chatPreview.innerText, font); // HTMLã®ãƒ†ã‚­ã‚¹ãƒˆã‚’getTextWidth() ã«æ¸¡ã™
				//console.log("Text Width:", textWidth); // ãƒ‡ãƒãƒƒã‚°ç”¨
				
				// textarea ã® padding ã‚’å–å¾—
				const paddingLeft = parseFloat(chatPreviewStyle.paddingLeft);
				const paddingRight = parseFloat(chatPreviewStyle.paddingRight);
				const textPadding = paddingLeft + paddingRight; // åˆè¨ˆã®padding
				const margin = 55;  // ä½™åŠ›ã®å€¤ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
				
				// ãƒ†ã‚­ã‚¹ãƒˆå¹…ã«paddingåˆ†ã¨ä½™åŠ›åˆ†ã®æ•°å­—ã‚’åŠ ãˆã‚‹
				const adjustedTextWidth = textWidth + textPadding + margin;
				//console.log("Adjusted Text Width:", adjustedTextWidth); // ãƒ‡ãƒãƒƒã‚°ç”¨
				
				// emojiãƒœã‚¿ãƒ³ã®å·¦å´ã®ä½ç½®ã‚’å–å¾—
				const emojiButtonLeft = emojiButton.getBoundingClientRect().left;
				//console.log("emojiButton Left: ", emojiButtonLeft); // ãƒ‡ãƒãƒƒã‚°ç”¨
				
				// PCã‹ã‚¹ãƒãƒ›ã‹åˆ¤å®šã—ã¦ã€å€‹åˆ¥ã®æ¡ä»¶ã§å‡¦ç†ã‚’ã•ã›ã‚‹ã€‚ã‚¹ãƒãƒ›ãªã‚‰emojiãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’è€ƒæ…®ã—ãªã„ 
				/*if (isMobile()) {
					// ã‚‚ã—æŠ˜ã‚Šè¿”ã—ãŒç™ºç”Ÿã—2è¡Œåˆ†ã«ãªã£ãŸã‚‰
					if (newHeight >= twoHeight) {
						input.style.height = "89px"; // 4è¡Œåˆ†ã®é«˜ã•ã«å¤‰æ›´
						messages.style.marginBottom = "70px"; // ul ã‚’ï¼”è¡Œåˆ†ã®é«˜ã•ä¸Šã’ã‚‹
						messages.scrollTo(0, messages.scrollHeight); // messageså†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
					} else {
						// å…ƒã®å€¤ã«æˆ»ã™
						messages.style.marginBottom = "23px";
					}
				} else {*/
					 // PCãªã‚‰emojiãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’è€ƒæ…®ã™ã‚‹
					 //ã‚‚ã—æŠ˜ã‚Šè¿”ã—ãŒç™ºç”Ÿã—2è¡Œåˆ†ã«ãªã‚‹ã€ã‚ã‚‹ã„ã¯æ–‡å­—ãŒãƒœã‚¿ãƒ³å·¦ç«¯ã®è·é›¢ã¾ã§ããŸã‚‰4è¡Œåˆ†ã®é«˜ã•ã‚’ç¢ºä¿
					if (newHeight >= twoHeight || adjustedTextWidth >= emojiButtonLeft) {
						chatPreview.style.height = "89px"; // 4è¡Œåˆ†ã®é«˜ã•ã«å¤‰æ›´
						messages.style.marginBottom = "70px"; // ul ã‚’ï¼”è¡Œåˆ†ã®é«˜ã•ä¸Šã’ã‚‹
						messages.scrollTo(0, messages.scrollHeight); // messagesã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
						// çµµæ–‡å­—ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å³ä¸‹ã«èª¿æ•´ã™ã‚‹
						emojiButton.style.top = "88%";
						emojiButton.style.transform = "translateY(-88%)";
					} else {
						// å…ƒã®å€¤ã«æˆ»ã™
						messages.style.marginBottom = "23px";
						emojiButton.style.top = "9px";
						emojiButton.style.transform = "none";
					}
				//}
			
				chatPreview.style.height = Math.min(chatPreview.scrollHeight, 205) + "px"; // æœ€å¤§205pxã¾ã§æ‹¡å¤§
				
				// PCã‹ã‚¹ãƒãƒ›ã‹åˆ¤å®šã—ã¦ã€å€‹åˆ¥ã®æ¡ä»¶ã§border-radiusã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ã€‚ã‚¹ãƒãƒ›ãªã‚‰emojiãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’è€ƒæ…®ã—ãªã„ 
				/*if (isMobile()) {
					// ã‚‚ã—æ”¹è¡ŒãŒã‚ã‚‹ or ç¾åœ¨ã®é«˜ã•ãŒï¼’è¡Œåˆ†(49px)ã‚’ã“ãˆãŸã‚‰ã€è‡ªå‹•ã§border-radiusã®å€¤ã‚’å¤‰æ›´ã™ã‚‹ã€‚
					if (newLine || newHeight >= twoHeight) {
						input.style.borderRadius = "0.8rem"; // æ”¹è¡Œã‚ã‚Š â†’ 0.8rem
					} else {
						input.style.borderRadius = "2rem"; // æ”¹è¡Œãªã— â†’ 2rem
					}
				} else {*/
					// PCãªã‚‰emojiãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’è€ƒæ…®ã™ã‚‹
					// æ”¹è¡ŒãŒã‚ã‚‹ or ç¾åœ¨ã®é«˜ã•ãŒï¼’è¡Œåˆ†(49px)ã«ãªã‚‹ or æ–‡å­—ãŒãƒœã‚¿ãƒ³å·¦ç«¯ã®è·é›¢ã¾ã§ãã¦ã„ãŸã‚‰å€¤ã‚’å¤‰æ›´ã™ã‚‹ã€‚
					if (newLine || newHeight >= twoHeight || adjustedTextWidth >= emojiButtonLeft) {
						chatPreview.style.borderRadius = "0.8rem"; // æ”¹è¡Œã‚ã‚Š â†’ 0.8rem
					} else {
						chatPreview.style.borderRadius = "2rem"; // æ”¹è¡Œãªã— â†’ 2rem
					}
				}
			//}
			
			// å…¥åŠ›æ™‚ã«é«˜ã•ã‚’èª¿æ•´
			chatPreview.addEventListener("input", () => {
				if (!isComposing) {
					canSubmit = true; // ã“ã“ã§é€ä¿¡OKã«ã™ã‚‹
  				}
				adjustTextareaHeight();
			});
			
			// `keyup` ã§ IMEç¢ºå®šç›´å¾Œã® `keydown` ã‚’é˜²ã
			chatPreview.addEventListener("keyup", (event) => {
    			if (event.key === "Enter" && !isComposing) {
        			canSubmit = true;
    			}
			});

			// ã‚·ãƒ•ãƒˆ+ã‚¨ãƒ³ã‚¿ãƒ¼ã§æ”¹è¡Œã€é€šå¸¸ã®ã‚¨ãƒ³ã‚¿ãƒ¼ã§é€ä¿¡
			chatPreview.addEventListener("keydown", (event) => {
				if (event.key === "Enter") {
					if (isComposing || !canSubmit) return; // IMEå¤‰æ›ä¸­ã¾ãŸã¯é€ä¿¡ä¸å¯ãªã‚‰ä½•ã‚‚ã—ãªã„

					event.preventDefault();
					if (event.shiftKey) {
						document.execCommand("insertLineBreak"); // ã‚·ãƒ•ãƒˆ + ã‚¨ãƒ³ã‚¿ãƒ¼ã§æ”¹è¡Œ
						//console.log("âœ… ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã¯æ”¹è¡Œå¾Œã®ç›´å¾Œã«ãªã‚‹ï¼"); // ãƒ‡ãƒãƒƒã‚°ç”¨
					} else {
						form.requestSubmit(); // ã‚¨ãƒ³ã‚¿ãƒ¼ã§é€ä¿¡
					}
				}
			});
			
			// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
			form.addEventListener("submit", async (event) => {
				event.preventDefault(); // ãƒšãƒ¼ã‚¸é·ç§»ã‚’é˜²ã

				let messageText = chatPreview.innerText.trim(); // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿å–å¾—ï¼†å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
			    let messageHtml = chatPreview.innerHTML.trim(); // HTMLå…¨ä½“ã‚’å–å¾—

				// **å‰å¾Œã® `<br>` ã‚’å‰Šé™¤**
				messageHtml = messageHtml.replace(/^(<br\s*\/?>)+|(<br\s*\/?>)+$/g, "");
				// **å‰å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚‚å‰Šé™¤ï¼ˆç©ºç™½ã ã‘ã®é€ä¿¡ã‚’é˜²ãï¼‰**
				messageHtml = messageHtml.replace(/^\s+|\s+$/g, "");
				
				input.value = messageHtml; // å‰å¾Œã®ç©ºç™½ã¨æ”¹è¡Œ\nã¨<br>ã‚’é™¤å»
				const trimmedValue = input.value;

				// âœ… ã€Œæ”¹è¡Œã‚’å‰Šé™¤ã—ãŸçŠ¶æ…‹ã§ messageText ãŒç©ºã‹ã©ã†ã‹ã‚’åˆ¤å®šã€
				const hasText = messageText.replace(/\n/g, "").trim().length > 0;
    			const hasEmote = chatPreview.querySelector("img");

				if (hasText || hasEmote) {
					console.log("ğŸš€ é€ä¿¡å‰ã® messageHtml:", messageHtml); // ãƒ‡ãƒãƒƒã‚°ç”¨
					console.log("ğŸš€ é€ä¿¡å‰ã® messageText:", messageText); // ãƒ‡ãƒãƒƒã‚°ç”¨

					try {
						const formData = new FormData(form);
						const name = formData.get("_name");
						const message = formData.get("_message").trim();
						const csrfToken = formData.get("_csrf");
						//const icon = twitchUserInfo.profile_image_url;

						console.log("ğŸ“ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:", { name, message }); // (ãƒ‡ãƒãƒƒã‚°ç”¨)

						// ã‚µãƒ¼ãƒãƒ¼ã¸POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ï¼ˆCSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã‚ã‚‹ï¼‰
						const response = await fetch('/submit', {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								"CSRF-Token": csrfToken  // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
							},
							body: JSON.stringify({ name, message })
						});

						const result = await response.json();
						console.log("ğŸ“ Server response:", result);

						// é€ä¿¡å¾Œã«æ–°ã—ã„ CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
						await updateCsrfToken();

					} catch (error) {
						console.error("Error during form submission:", error);
					}

					console.log("é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", trimmedValue); // é€ä¿¡å†…å®¹ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰

					const data = {
						icon: twitchUserInfo?.profile_image_url || "/icon/profile_sample_image-300x300.jpg", // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ç”»åƒï¼‰
						name: twitchUserInfo?.display_name || "åŒ¿å", // Twitchã®ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãƒãƒ¼ãƒ ï¼ˆãªã‘ã‚Œã°ã€ŒåŒ¿åã€ï¼‰
						text: trimmedValue,
					};
					
					//console.log("ğŸ“¤ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:", data); // (ãƒ‡ãƒãƒƒã‚°ç”¨)
					socket.emit('chat message', data);
					
					chatPreview.innerHTML = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
					chatPreview.style.height = "39px"; // åˆæœŸã®é«˜ã•ã«æˆ»ã™
					chatPreview.style.borderRadius = "2rem"; // åˆæœŸå€¤ã«æˆ»ã™
					chatPreview.blur(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™ï¼ˆã‚¹ãƒãƒ›ãªã‚‰ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹ï¼‰

					emojiButton.style.top = "9px"; // åˆæœŸã®é«˜ã•ã«æˆ»ã™
					emojiButton.style.transform = "none"; // åˆæœŸå€¤ã«æˆ»ã™
					messages.style.marginBottom = "23px"; // åˆæœŸã«æˆ»ã™
					
					// é€ä¿¡ãƒœã‚¿ãƒ³ã®è‰²ã‚’ãƒªã‚»ãƒƒãƒˆ
					if (document.body.classList.contains("dark-mode")) {
						sendImg.style.filter = 
						"invert(99%) sepia(67%) saturate(429%) hue-rotate(195deg) brightness(116%) contrast(78%)";
					} else {
						sendImg.style.filter = 
						"invert(22%) sepia(16%) saturate(4%) hue-rotate(315deg) brightness(102%) contrast(81%)";
					}
					// PCãªã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™ï¼ˆã‚¹ãƒãƒ›ã§ã¯æˆ»ã•ãªã„ï¼‰
					if (!isMobile()) {
						setTimeout(() => chatPreview.focus(), 100);
					}
				}
			});
			
			// æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒããŸæ™‚ã®å‡¦ç†
			socket.on('chat message', function(m) {
				console.log("ğŸ“© ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å—ä¿¡:", m);
				// æŠ•ç¨¿æ™‚é–“ã‚’å–å¾—ã™ã‚‹
				let postTime = new Date().toLocaleString("en-US",{
					timeZone: "Asia/Tokyo",
					hour: "numeric",
					minute: "numeric",
					hour12: true
				}); // è‹±èªåœã®ãƒ­ã‚±ãƒ¼ãƒ«ï¼ˆä¾‹: en-USï¼‰ã‚’ä½¿ã„ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§æ—¥æœ¬ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
				let item = document.createElement('li');
				item.innerHTML = `
					<span class="msg-icon"><img src="${m.icon}"></span>
					<div class="msg-contents">
						<time>${postTime}</time>
						<span class="msg-name">${m.name}</span>
						<span class="msg-text">${m.text}</span>
					</div>
				`;
				messages.appendChild(item);
				messages.scrollTo(0, messages.scrollHeight); // messageså†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
				onMessageSent(); // é€ä¿¡ã™ã‚‹timeã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã«å¯¾å¿œã™ã‚‹é–¢æ•°
			});
		</script>
	</body>
</html>